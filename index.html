<!DOCTYPE html>
<html>

<head>
    <title>Power Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #1a1a1a;
            color: white;
            padding: 20px;
        }

        #status-box {
            padding: 40px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 2em;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.5s ease;
        }

        .online {
            background-color: #27ae60;
            box-shadow: 0 0 30px #27ae60;
        }

        .offline {
            background-color: #c0392b;
            box-shadow: 0 0 30px #c0392b;
        }

        .loading {
            background-color: #7f8c8d;
        }

        #time-text {
            margin-top: 20px;
            font-size: 1.2em;
            color: #bdc3c7;
        }

        #details {
            margin-top: 10px;
            font-size: 0.8em;
            color: #7f8c8d;
        }
    </style>
</head>

<body>

    <h1>üè† Gharachi Light</h1>

    <div id="status-box" class="loading">Loading...</div>

    <div id="time-text">Checking server...</div>
    <div id="details"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPF0ohJREtl2HK43_q9A7YW5q07_Dp7eM",
            databaseURL: "https://kamble-home-power-monitor-default-rtdb.asia-southeast1.firebasedatabase.app",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // References
        const lastSeenRef = ref(db, 'status/last_seen');
        const offsetRef = ref(db, '.info/serverTimeOffset');

        let lastSeenTime = 0;
        let serverOffset = 0;

        // 1. Get the "Clock Skew" (Difference between your phone and Google)
        onValue(offsetRef, (snap) => {
            serverOffset = snap.val();
        });

        // 2. Get the last heartbeat from ESP32
        onValue(lastSeenRef, (snapshot) => {
            if (snapshot.exists()) {
                lastSeenTime = snapshot.val();
                updateUI();
            }
        });

        const statusBox = document.getElementById('status-box');
        const timeText = document.getElementById('time-text');
        const details = document.getElementById('details');

        function updateUI() {
            if (lastSeenTime === 0) return;

            // CORRECT MATH: (YourTime + OffsetError) - LastSeen
            const estimatedServerTime = Date.now() + serverOffset;
            let diffSeconds = Math.floor((estimatedServerTime - lastSeenTime) / 1000);

            // Cosmetic fix: If it's -1 or -2 due to lag, just show 0
            if (diffSeconds < 0) diffSeconds = 0;

            // Logic: If ESP32 hasn't spoken in 70 seconds, it's dead.
            // (We use 70s because your loop is 10s + network delay)
            if (diffSeconds < 70) {
                statusBox.innerText = "LIGHT AHE üòé";
                statusBox.className = "online";
                statusBox.style.color = "white";
            } else {
                statusBox.innerText = "LIGHT GELI üïØÔ∏è";
                statusBox.className = "offline";
            }

            timeText.innerText = `Last Heartbeat: ${diffSeconds} seconds ago`;
            details.innerText = `Last seen: ${new Date(lastSeenTime).toLocaleTimeString()}`;
        }

        // Run the UI update every second to make the counter tick
        setInterval(updateUI, 1000);
    </script>

</body>

</html>